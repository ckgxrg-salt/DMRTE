# DMRTE  
Rust版本的DMIAE: 一个用于操纵戏剧和游戏剧本的简易工具.
包含DMIAE Rust API和用于操纵剧本文件的命令行工具.

# 目录
- 结构
- 源剧本文件语法
- 源剧本文件属性
- DMIAE API
- 技巧

# 结构
DMRTE需要一个源剧本文件以工作.   
源剧本文件应该是纯文本文件, 而且需要用下述的语法书写.   
使用DMRTE转译剧本文件后, 会生成一个包含序列化后的数据结构的文件.   
此生成的文件可以在之后由DMIAE API直接读取为代码可读的数据结构.   
简单来说, DMIAE API定义剧本的数据结构; DMRTE工具, 或者其它实现此功能的工具, 利用API定义的数据结构操纵剧本.   

# 源剧本文件语法
此部分描述DMRTE的转译过程.   

## 标签与段落
DMIAE利用标签与段落将台词分类.   
标签可以被一个特定语法打到台词上.   
标签主要用于更好地在剧本中定位台词, DMRTE支持显示所有具有指定标签的台词.   

段落表示一组文字. 通常的剧本都具有"第三话", "第九幕"之类的层级结构, "段落"正是表示此概念. 段落可以嵌套, 所以不必写"第一话第二幕", 而可以写"第一话"后紧跟"第二幕".   
段落是DMIAE的基本结构. 事实上, DMIAE"剧本"主要就是段落的集合体: 角色的台词需要被存储在某个段落里.(不允许独立的台词)

## 语句类型
- 注释
- 属性
- 角色声明
- 段落标记
- 角色台词

## 注释
```
// [注释内容]
```
以"//"开头的语句被视为注释.   
源文件是人类可读的格式, 诸如"作者", "剧本名称"之类的属性不会被DMIAE默认存储, 可以在注释中声明.   
如果不指定"保留所有内容", DMRTE会舍弃所有注释.   

## 属性
以"!"开头的语句被视为属性.   
每个属性的语法相对有不同, 具体描述在下一部分.   
属性可以是静态或者动态的.   
静态属性描述关于剧本的一些基础信息, 不应该被定义多次. DMRTE禁止重复定义静态属性. 静态属性的位置不影响其作用.   
动态属性提供有关角色台词的额外信息. 多次定义会有不同的效果, 具体会在下一部分描述. 通常, 动态属性影响其之后的台词.   

## 角色声明
此格式的语句声明一个角色.   
```
@<角色名>, [别名], [别名]... [:描述]
```
这些语句必须在段落外定义, 最自然的地方就是在开头, 虽然其它地方也可以.   

至少声明一个角色名, 这将是角色的标识符, 并会在内部被DMIAE使用.   
冒号可以在角色的所有名字后增加说明.   
对于有多个别名的角色, 使用逗号分割每个别名.   

角色名字可以包含空格, 但是首尾的空格会被忽略.   

任何出现在剧本中的角色需要被声明, 不然他们的台词会被认为是其他角色台词的一部分.   
声明的角色名应当与剧本中的名字完全一致.   
```
@Elle, Legally Blonde
@Hamilton
@Judge: A maniac
```

## 段落标记
">"标记一个段落的开始.   
```
> <段落名>, [别名], [别名]... [:描述]
```
段落, 类似角色, 可以有别名, 大部分用于多语言情况下.   
使用"<"来结束一个段落, 这会结束最目前内层的段落.   
这些段落标记可以在一行中多次出现, 所以`> 第一话 > 第二幕`是正确的.   
亲段落不能拥有一个与自己同名的子段落, 所以如果这样写:
```
> 第一话 > 第一幕
<
> 第一话 > 第二幕
<
```
生成的数据结构会为:
```
第一话
  - 第一幕
  - 第二幕
```
```
> 第一话 > 第一幕
台词和台词
<
> 第二幕
还是台词
<<
> 第二话
<
```

## 角色台词
角色台词应该在段落内出现.   
冒号用于分割角色名与文本.   
台词可以不写角色名和冒号, 此时该台词会继承上一个台词的角色.   
```
Elle: I feel so much better,
I feel so much better,
I feel so much better than before

Emmett: Don't spend hours on my hair
Elle: (I don't spend hours)
```   

### 转义字符
如果你真的需要用"//", "#", "@"等开头, 使用"\"对其进行转义.   

### 多角色台词
如果一个台词属于多个角色, 使用"/"分割每个角色名.   
```
HAMILTON/MULLIGAN /LAURENS/LAFAYETTE
I am not throwing away my shot.
```   

### 标签
使用此语法为一个台词打上标签:
```
#<标签名> [角色名:] <内容>
```
因此, 标签名内不允许使用空格.   

标签可以用于分类台词, 例如, 当你需要写双语剧本:
```
#en William: Catch me if you can.
#cn 威廉: 能的话就来抓我吧.
```
然后就可以利用DMRTE去生成指定语言的剧本.   

但是, 手动定义标签费时费力, 可以使用"tagrule"动态属性来自动为台词打上标签.   

可以在标签名前加"-"以移除某个标签, 所以`#-en`会移除台词上的"en"标签.   

### 行动
行动是非语言的表演, 例如光效, 音乐或者只是笔记.   
使用此语法定义行动:
```
[角色名:] <文本 (@<行动类型> [行动内容]) 还是文本 (@行动) 依然是文本>
```
行动被包裹在台词内, 并且会记录其在台词中的位置.   
行动也可以被包裹在空台词中.   

行动具有类型和内容, 都是任意字符串.   
具有行动的台词会自动获得"#action-行动类型"标签.   

示例:
```
(@Light 红1面2)
All: Blood in the water.(@Note 开始逼近)
水中之血。
Callahan: Becomes your only law.
成为你唯一的法则。
(@Note Callahan关门)(@Audio Blood in the water结束)
```   

# 源剧本文件属性
并非所有属性都会默认记录到转译后的文件中. 静态属性都会被存储, 动态属性则看具体情况.   

## 静态属性

## 动态属性
### tagrule
"tagrule"定义自动为台词打标签的规则.   
默认会被舍弃.   
```
!tagrule [nomark] <相对位置> [标签] [+标签] [-标签]...
!tagrule reset
```
其中相对位置是:
- this
- after <行数>

tagrule对其之后的台词生效.   
对于每一行, DMRTE依据定义的相对位置自动处理标签.   
受到tagrule影响过的台词自动获得"#!tagrule.ignore"标签, 有此标签的台词不会被tagrule再次选中为"this", 此行为可以被[nomark]关闭.   
当然, 手动添加这个标签会令tagrule无视某行台词.   
```
!tagrule this +en
!tagrule after 1 +cn

Whiteley: How did you...? <- 假设DMRTE正在处理此行
怀特利: 你怎么...?

Whiteley: How did you...? <- 被称为"this"
怀特利: 你怎么...? <- 被称为"after 1"

Whiteley: How did you...? <- 添加标签"#en"和"#!tagrule.ignore"
怀特利: 你怎么...? <- 添加标签"#cn"和"#!tagrule.ignore"

Whiteley: How did you...? <- 
怀特利: 你怎么...? <- DMRTE尝试前进, 但本行已有"#!tagrule.ignore", 所以会向前寻找tagrule的下一个目标
```
[+tag]或[tag]添加一个标签, [-tag]移除一个标签.   
重复定义tagrule会增加或补充已有的tagrule, 使用!tagrule reset来清空所有的tagrule.   

# DMIAE API
此部分描述DMIAE内部的数据结构.   

DMIAE剧本
  - 静态属性
    - 属性
    - 属性
    - ...其它属性

  - 角色
    - 角色1
      - 别名
      - 描述
    - 角色2...

  - 某段落
    - 别名
    - 描述
    - 亲段落
    - 台词1...
    - 子段落
      - 台词1
        - 角色
        - 文本
        - 标签
        - 行动
          - 类型
          - 内容
      - 台词2...

## 静态属性
包含可为空的字段的结构体.   

## 角色
以角色名为键, 角色结构体为值的HashMap.   

每个角色结构体包含其角色名, 可能的别名列表, 可能的描述.   

## 段落
主要内容.   
以段落名为键, 段落结构体为值的HashMap.   

每个段落包含其段落名, 可能的对亲段落的引用, 可能的别名列表, 可能的描述, 可能的台词结构体列表以及可能的子段落结构体列表.   

每个台词结构体包含其所属角色列表, 文本, 可能的标签列表, 可能的行动结构体列表.   

每个行动结构体包含其类型和可能的内容.   

# 技巧
## 使用多个源剧本文件
这在创作多语言项目时有用, 因为不需要在一个文件内写大量的多语言内容和tagrule.   

### 角色和段落
角色声明, 只要其主要"角色名"相同, 可以被多次定义以增加别名. 比如说, 有2种版本的剧本, 一个英文版与一个中文版:
```英文版
@William
```
```中文版
@William, 威廉
```
DMRTE会认为这两个人是同一个角色, 除了使用某个特定语言, 也可以用一个特定的字符串来"锚定"角色.   

段落同样支持别名, 所以基本上一致.   

### 内容
DMRTE会合并相同名字的段落.   
你可以定义DMRTE如何安排合并后的台词.   
例如, 如果你不在乎行号, 那就将内容"append"在另一个版本后面.   
或者, 可以"one-after-one"将内容隔行插入.   
